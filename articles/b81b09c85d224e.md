---
title: "Docker ã§ rails ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹æ‰‹é †ï¼ˆPostgreSQLï¼‰"
emoji: "ğŸšŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["docker", "ruby", "rails", "PostgreSQL"]
published: false
---

Docker ã§ rails ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦èµ·å‹•ã§ãã‚‹ã¾ã§ã®æ‰‹é †ã§ã™ã€‚
WEB ã§èª¿ã¹ã‚‹ã¨ä½•ç¨®é¡ã‹ã‚„ã‚Šæ–¹ãŒå‡ºã¦ãã‚‹ã®ã§ã™ãŒã€ä½œæˆã•ã‚Œã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæ„å›³ã—ãŸã‚‚ã®ãŒä½œã‚Œãªã‹ã£ãŸã‚Šã€æ‰‹é †é€šã‚Šã«ã—ã¦ã‚‚ã™ã‚“ãªã‚Šèµ·å‹•ã§ããªã£ãŸã‚Šã¨ã—ã£ãã‚Šãã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

æ‰‹é †é€šã‚Šã«ã—ã¦ã‚‚ã™ã‚“ãªã‚Šèµ·å‹•ã§ããªã„å ´åˆã«ã‚¨ãƒ©ãƒ¼ã‚’ç†è§£ã—ã¦è‡ªåˆ†ã§å¯¾å‡¦ã™ã‚‹ã“ã¨ã‚‚ã§ããšå›°ã£ã¦ã„ã¾ã—ãŸã€‚
ãã‚‚ãã‚‚ Docker ã‚„ rails ã«ã¤ã„ã¦ã‚‚åˆå­¦è€…ã§ã‚ã‚‹ãŸã‚ã€ã¾ãšã¯åŸºæœ¬çš„ãªæ§‹ç¯‰æ–¹æ³•ã‚’ç¿’å¾—ã—ã€ãã“ã‹ã‚‰ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ç†è§£ã—ãŸã„ã¨æ€ã£ãŸã®ã§åŸºæœ¬çš„ãªçŠ¶æ…‹ã§ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èµ·å‹•æ‰‹é †ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚

ã“ã®æ‰‹é †ã®ç›®çš„ã¯ rails ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ–°è¦ä½œæˆã—ã€ãã®çŠ¶æ…‹ã§èµ·å‹•ç¢ºèªã§ãã‚‹ã¨ã“ã‚ã¾ã§ãªã®ã§ã€ã“ã®æ‰‹é †é€šã‚Šã«ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãã®ã¾ã¾ä½¿ã†ã®ã§ã¯ãªãã€ã‚ãã¾ã§åŸºç¤ã¨ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

æœ€åˆã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ãŸè¨­å®šã‚’ã—ã¦æ§‹ç¯‰ã§ãã‚Œã°ã„ã„ã®ã§ã™ãŒã€ãã‚‚ãã‚‚èµ·å‹•ã§ãã‚‹çŠ¶æ…‹ã®ã‚‚ã®ãŒãªã‘ã‚Œã°ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ããªã„ã®ã§ã€ãã®ç´ ä½“ã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚

### ä½œæˆã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

æœ€åˆã« rails ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«æ§‹ç¯‰ã—ã¦ã‹ã‚‰ Docker ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã®ã§ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®æ§‹ç¯‰ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

- MacOS
  - ruby 3.2.2
  - rails 7.1.1
  - postgres 16

## æ§‹ç¯‰æ‰‹é †

1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’æ§‹ç¯‰
   1. rbenv ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   2. ruby ã¨ rails ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   3. postgresql ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   4. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã« rails new ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
2. Docker ã§ãƒ“ãƒ«ãƒ‰ã—ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èµ·å‹•
   1. env ãƒ•ã‚¡ã‚¤ãƒ«ã¨ comopse.yaml ã‚’ä½œæˆ
   2. database.yml ã‚’ç·¨é›†
   3. docker ã§ãƒ“ãƒ«ãƒ‰
   4. DB ã‚’ä½œæˆã™ã‚‹
   5. docker-compose up ã§èµ·å‹•ã—ã¦ rails ã®åˆæœŸç”»é¢ã‚’ç¢ºèª

ç’°å¢ƒãŒã§ãã¦ã—ã¾ãˆã°æ‰‹é–“ã¯ `env ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ` ã¨ `compose.yaml ã®ä½œæˆ`ã€`database.yml`ã®ä¿®æ­£ã€`DB ã®ä½œæˆ` ã ã‘ã§ã™ã€‚

## ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’æ§‹ç¯‰

### rbenv ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```zsh
# Homebrew ã‚’ä½¿ã£ã¦ rbenv ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
% brew install rbenv
# rbenvã‚’ã‚·ã‚§ãƒ«ã«çµ„ã¿è¾¼ã‚€è¨­å®š
% echo 'eval "$(rbenv init --path)"' >> ~/.zshrc
# ã‚·ã‚§ãƒ«ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
% source ~/.zshrc
```

### ruby ã¨ rails ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```zsh
# Rubyã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
% rbenv install 3.2.2
% rbenv global 3.2.2
# Railsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
% gem install rails -v 7.1.1
```

### PostgreSQL ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
# PostgreSQLã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
brew install postgresql
```

### rails ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ

Database ã« PostgreSQL ã‚’æŒ‡å®šã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```zsh
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
% rails new myapp -d postgresql
# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç§»å‹•
% cd myapp
```

### rails ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã« env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
myapp
â””â”€â”€ .env
    â”œâ”€â”€ development
    â”‚   â”œâ”€â”€ database
    â”‚   â””â”€â”€ web
    # ãã®ä»–ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
```

`.env/development/database` ã®å†…å®¹
DB ã®æ¥ç¶šæƒ…å ±ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```
POSTGRES_DB=myapp_development
POSTGRES_USER=postgres
POSTGRES_PASSWORD=password
```

`.env/development/web` ã®å†…å®¹
å¾Œè¿°ã™ã‚‹ `Dockerfile` ã«ã¯ `RAILS_ENV` ã§æœ¬ç•ªç’°å¢ƒãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€é–‹ç™ºç’°å¢ƒã§èµ·å‹•ã™ã‚‹ã‚ˆã†ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¾ã™ã€‚

```
RAILS_ENV=development
```

### rails ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã« compose.yaml ã‚’ä½œæˆã™ã‚‹

ä»Šå›ã€ `Dockerfile` ã¯ `rails new` ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ãŸéš›ã«è‡ªå‹•ã§ä½œæˆã•ã‚Œã‚‹ã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¾ã™ã€‚
ã¾ãŸã€ã‚ˆã rails å›ºæœ‰ã®ã‚µãƒ¼ãƒãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆserver.pidï¼‰ã®å‰Šé™¤ã®ãŸã‚ã« `docker-entrypoint.sh` ãªã©ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ãŒã€ã“ã¡ã‚‰ã‚‚ `/rails/bin/docker-entrypoint` ã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ä½œæˆã—ã¾ã›ã‚“ã€‚
ã“ã“ã§ã¯ `docker-compose` ç”¨ã« `compose.yaml` ã®ã¿ã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml
services:
  db:
    image: postgres:16
    ports:
      - "5432:5432"
    env_file:
      - .env/development/database
    volumes:
      - "db_data:/var/lib/postgresql/data"
  web:
    build: .
    env_file:
      - .env/development/web
      - .env/development/database
    command: bash -c "bundle e rails s -b '0.0.0.0'"
    volumes:
      - .:/usr/src/app
      - gem_cache:/gems
    ports:
      - "3000:3000"
    depends_on:
      - db
volumes:
  db_data:
  gem_cache:
```

ã¡ãªã¿ã«è‡ªå‹•ã§ä½œæˆã•ã‚Œã‚‹ `Dockerfile` ã®å†…å®¹ã¯ã“ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ä½œæˆã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
å†…å®¹ã«ã¤ã„ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚

```docker
# syntax = docker/dockerfile:1

# Make sure RUBY_VERSION matches the Ruby version in .ruby-version and Gemfile

ARG RUBY_VERSION=3.2.2
FROM registry.docker.com/library/ruby:$RUBY_VERSION-slim as base

# Rails app lives here

WORKDIR /rails

# Set production environment

ENV RAILS_ENV="production" \
 BUNDLE_DEPLOYMENT="1" \
 BUNDLE_PATH="/usr/local/bundle" \
 BUNDLE_WITHOUT="development"

# Throw-away build stage to reduce size of final image

FROM base as build

# Install packages needed to build gems

RUN apt-get update -qq && \
 apt-get install --no-install-recommends -y build-essential git libpq-dev libvips pkg-config

# Install application gems

COPY Gemfile Gemfile.lock ./
RUN bundle install && \
 rm -rf ~/.bundle/ "${BUNDLE_PATH}"/ruby/*/cache "${BUNDLE*PATH}"/ruby/*/bundler/gems/\_/.git && \
 bundle exec bootsnap precompile --gemfile

# Copy application code

COPY . .

# Precompile bootsnap code for faster boot times

RUN bundle exec bootsnap precompile app/ lib/

# Precompiling assets for production without requiring secret RAILS_MASTER_KEY

RUN SECRET_KEY_BASE_DUMMY=1 ./bin/rails assets:precompile

# Final stage for app image

FROM base

# Install packages needed for deployment

RUN apt-get update -qq && \
 apt-get install --no-install-recommends -y curl libvips postgresql-client && \
 rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Copy built artifacts: gems, application

COPY --from=build /usr/local/bundle /usr/local/bundle
COPY --from=build /rails /rails

# Run and own only the runtime files as a non-root user for security

RUN useradd rails --create-home --shell /bin/bash && \
 chown -R rails:rails db log storage tmp
USER rails:rails

# Entrypoint prepares the database.

ENTRYPOINT ["/rails/bin/docker-entrypoint"]

# Start the server by default, this can be overwritten at runtime

EXPOSE 3000
CMD ["./bin/rails", "server"]
```

ã¾ãŸã€`/rails/bin/docker-entrypoint` ã®å†…å®¹ã¯ã“ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```bash
#!/bin/bash -e

# If running the rails server then create or migrate existing database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  ./bin/rails db:prepare
fi

exec "${@}"
```

### rails ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã® database.yml ã‚’ç·¨é›†ã™ã‚‹

DB ã¨æ¥ç¶šã™ã‚‹ãŸã‚ã« `config/database.yml` ã‚’ä¿®æ­£ã—ã¾ã™ã€‚
`host`ã€`username`ã€`password` ã‚’è¿½è¨˜ã—ã¾ã™
å¿…è¦ã«å¿œã˜ã¦ `database` ã‚‚ä¿®æ­£ã—ã¾ã™ã€‚

```yaml
default: &default
  adapter: postgresql
  encoding: unicode
  host: db # compose.yaml ã® DB ã‚³ãƒ³ãƒ†ãƒŠåã‚’æŒ‡å®šã™ã‚‹
  username: <%= ENV['POSTGRES_USER'] %> # è¿½åŠ 
  password: <%= ENV['POSTGRES_PASSWORD'] %> # è¿½åŠ 
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>

development:
  <<: *default
  database: myapp_development
```

### Docker ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹

```

% docker-compose build

```

### DB ã‚’ä½œæˆ

```
# ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•å‰ï¼ˆæ‰‹é †é€šã‚Šï¼‰ãªã‚‰ã“ã¡ã‚‰
% docker-compose run web rake db:create
% docker-compose run web rake db:migrate
# ã‚³ãƒ³ãƒ†ãƒŠã‚’å…ˆã«èµ·å‹•ã•ã›ãŸå ´åˆã¯ã“ã¡ã‚‰
% docker-compose exec web rake db:create
% docker-compose exec web rake db:migrate
```

### èµ·å‹•ç¢ºèª

`docker-compose` ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™ã€‚

```
% docker-compose up
```

### æ¥ç¶šç¢ºèª

http://localhost:3000 ã«æ¥ç¶šã—ã¦ç¢ºèªã™ã‚‹

ã“ã‚Œã§ rails ã®åˆæœŸç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°ã²ã¨ã¾ãšæˆåŠŸã§ã™ã€‚
ãŸã æœ€åˆã«è¿°ã¹ãŸã‚ˆã†ã«ã‚ãã¾ã§ã‚‚ã“ã‚Œã¯ç´ ä½“ãªã®ã§ã“ã“ã‹ã‚‰å¿…è¦ã«å¿œã˜ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

ä»Šå›ã¯ã“ã“ã¾ã§ã§ã™ãŒã€æ°—ã«ãªã£ãŸç‚¹ãªã©ã‚’ ChatGPT ã«èã„ã¦ã¿ãŸã®ã§ãã®å†…å®¹ã‚’æ®‹ã—ã¦ãŠãã¾ã™ã€‚
ç§ã¯åˆå­¦è€…ã§ã™ã®ã§ã“ã‚Œã‚‰ã®ã“ã¨ã«é–¢ã—ã¦ã¾ã è©³ã—ããªã„ãŸã‚æ­£èª¤ã®åˆ¤æ–­ã¯ã§ãã¾ã›ã‚“ãŒã€å‚è€ƒã«ãªã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

**ã“ã‚Œã‚ˆã‚Šå…ˆã¯ AI ã«ã‚ˆã‚‹å‡ºåŠ›å†…å®¹ã§ã™ã€‚**

---

# rails new ã§è‡ªå‹•ã§ä½œæˆã•ã‚Œã‚‹ Dockerfile ã®å†…å®¹ã«ã¤ã„ã¦

ã“ã® Dockerfile ã¯ã€Rails ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã™ã‚‹ãŸã‚ã®ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®ä¸€ä¾‹ã§ã™ã€‚ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€æœ€çµ‚çš„ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’å°ã•ãæŠ‘ãˆã¤ã¤ã€ãƒ“ãƒ«ãƒ‰ã‚„ã‚¢ã‚»ãƒƒãƒˆã®ãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãªã©ã‚’åŠ¹ç‡çš„ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ãã‚Œã§ã¯ã€å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

### ãƒ™ãƒ¼ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¸

```Dockerfile
# syntax = docker/dockerfile:1

ARG RUBY_VERSION=3.2.2
FROM registry.docker.com/library/ruby:$RUBY_VERSION-slim as base

WORKDIR /rails

ENV RAILS_ENV="production" \
    BUNDLE_DEPLOYMENT="1" \
    BUNDLE_PATH="/usr/local/bundle" \
    BUNDLE_WITHOUT="development"
```

#### è§£èª¬

- **1 è¡Œç›®** ã§ã¯ã€Dockerfile ã®æ§‹æ–‡ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚æ–°ã—ã„ãƒ“ãƒ«ãƒ‰æ©Ÿèƒ½ã‚„æ§‹æ–‡ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã§ã™ã€‚
- **ARG** ã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ **RUBY_VERSION** ã¯ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦è¨­å®šå¯èƒ½ãªå¤‰æ•°ã§ã™ã€‚ã“ã“ã§ã¯ Ruby ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
- **FROM** ã¯ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€slim ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè»½é‡ç‰ˆï¼‰ã® Ruby ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
- **WORKDIR** ã§ã€ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰ã‚’æŒ‡å®šã—ã¾ã™ã€‚
- **ENV** ã§ã€ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€Rails ã®å®Ÿè¡Œç’°å¢ƒã€Bundler ã®è¨­å®šãªã©ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

### ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸

```Dockerfile
FROM base as build

RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y build-essential git libpq-dev libvips pkg-config

COPY Gemfile Gemfile.lock ./
RUN bundle install && \
    rm -rf ~/.bundle/ "${BUNDLE_PATH}"/ruby/*/cache "${BUNDLE_PATH}"/ruby/*/bundler/gems/*/.git && \
    bundle exec bootsnap precompile --gemfile

COPY . .

RUN bundle exec bootsnap precompile app/ lib/

RUN SECRET_KEY_BASE_DUMMY=1 ./bin/rails assets:precompile
```

#### è§£èª¬

- **ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸** ã¯ã€ãƒ™ãƒ¼ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å…ƒã«ãƒ“ãƒ«ãƒ‰ç”¨ã®ç’°å¢ƒã‚’ä½œã‚Šã¾ã™ã€‚
- **apt-get** ã§ã€Gems ã®ãƒ“ãƒ«ãƒ‰ã‚„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
- **COPY** ã§ Gemfile ã‚’ã‚³ãƒ”ãƒ¼ã—ã€ **bundle install** ã§ Gems ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ãã®å¾Œã€ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚µã‚¤ã‚ºã‚’æŠ‘ãˆã¦ã„ã¾ã™ã€‚
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã€bootsnap ã‚’ãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã€ã‚¢ã‚»ãƒƒãƒˆã‚’ãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¾ã™ã€‚

### ãƒ•ã‚¡ã‚¤ãƒŠãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸

```Dockerfile
FROM base

RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y curl libvips postgresql-client && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

COPY --from=build /usr/local/bundle /usr/local/bundle
COPY --from=build /rails /rails

RUN useradd rails --create-home --shell /bin/bash && \
    chown -R rails:rails db log storage tmp
USER rails:rails

ENTRYPOINT ["/rails/bin/docker-entrypoint"]

EXPOSE 3000
CMD ["./bin/rails", "server"]
```

#### è§£èª¬

- **ãƒ•ã‚¡ã‚¤ãƒŠãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸** ã¯ã€æœ€çµ‚çš„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ™ãƒ¼ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å…ƒã«ã€å®Ÿè¡Œã«å¿…è¦ãªæœ€ä½é™ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
- **COPY --from=build** ã§ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ã§ç”¨æ„ã—ãŸ Gems ã‚„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼`rails`ã‚’ä½œæˆã—ã€ä¸€éƒ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚ªãƒ¼ãƒŠãƒ¼ã‚·ãƒƒãƒ—ã‚’è¨­å®šå¾Œã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã®ãŸã‚ï¼‰ã€‚
- **ENTRYPOINT** ã§ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’æŒ‡å®šã—ã¾ã™ã€‚
- **EXPOSE** ã§å…¬é–‹ã™ã‚‹ãƒãƒ¼ãƒˆã‚’æŒ‡å®šã—ã¾ã™ã€‚
- **CMD** ã§ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã™ã‚‹éš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚³ãƒãƒ³ãƒ‰ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã“ã§ã¯ Rails ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™ã€‚

ã“ã® Dockerfile ã§ã¯ã€ãƒãƒ«ãƒ

---

### Dockerfile ã«ã¤ã„ã¦

- **é–‹ç™ºç”¨ Dockerfile**ï¼šé–‹ç™ºç”¨ã®`Dockerfile`ã¯ãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’çŸ­ç¸®ã™ã‚‹ãŸã‚ã€ã‚ã‚‹ç¨‹åº¦ã‚·ãƒ³ãƒ—ãƒ«ã«ä¿ã¤ã®ãŒè‰¯ã„ã§ã™ã€‚ã¾ãŸã€é–‹ç™ºã§ã¯ãƒ‡ãƒãƒƒã‚°ã‚„ãƒ†ã‚¹ãƒˆã®ãŸã‚ã®è¿½åŠ ãƒ„ãƒ¼ãƒ«ãŒå¿…è¦ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ä»¥ä¸‹ã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ãªé–‹ç™ºç”¨`Dockerfile`ã®ä¸€ä¾‹ã§ã™ã€‚

```Dockerfile
FROM ruby:3.2.2

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && \
    apt-get install -y build-essential libpq-dev nodejs

# Yarnã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - \
    && echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list \
    && apt-get update && apt-get install -y yarn

WORKDIR /myapp

# Gemãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY Gemfile* /myapp/
RUN bundle install

# ãã®ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚½ãƒ¼ã‚¹ã‚’ã‚³ãƒ”ãƒ¼
COPY . /myapp
```

ã“ã®`Dockerfile`ã§ã¯ã€ã‚¢ã‚»ãƒƒãƒˆã®ãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãªã©æœ¬ç•ªç‰¹æœ‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’çœç•¥ã—ã¦ã„ã¾ã™ã€‚é–‹ç™ºä¸­ã¯ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒé »ç¹ã«ã‚ã‚‹ãŸã‚ã€ãƒ“ãƒ«ãƒ‰ã‚’é«˜é€Ÿã«ä¿ã¤ã“ã¨ãŒé‡è¦ã§ã™ã€‚

### è£œè¶³

- **æœ€ä½é™ã®æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼**ï¼šæœ¬ç•ªç’°å¢ƒã§ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã™ã‚‹ãŸã‚ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ root ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å®Ÿè¡Œã›ãšã€é™å®šã•ã‚ŒãŸæ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å®Ÿè¡Œã™ã¹ãã§ã™ã€‚

å…·ä½“çš„ã«ã¯ã€`Dockerfile`ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ ã—ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```Dockerfile
RUN useradd -m myuser
USER myuser
```

ä¸Šè¨˜ã‚’`Dockerfile`ã®é©åˆ‡ãªä½ç½®ã«è¿½åŠ ã—ã¾ã™ã€‚

- **æœ¬ç•ªç’°å¢ƒã§ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆã®é¿ã‘æ–¹**ï¼šæœ¬ç•ªç’°å¢ƒã§ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠã«ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã€å¤‰æ›´ã®ãªã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

`Dockerfile`ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

```Dockerfile
COPY . /myapp
```

é–‹ç™ºç’°å¢ƒã§ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ãƒã‚¦ãƒ³ãƒˆã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ã™ãã«åæ˜ ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ãŒã€æœ¬ç•ªç’°å¢ƒã§ã¯ã“ã®ã‚ˆã†ãªå‹•ä½œã¯æœ›ã¾ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€`docker-compose.yml`ã«ãŠã„ã¦ã€æœ¬ç•ªç”¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚„`docker-compose.override.yml`ãªã©ï¼‰ã‚’ä½œæˆã—ã€ãã“ã§ã¯ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ãƒã‚¦ãƒ³ãƒˆã‚’è¡Œã‚ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚

é–‹ç™ºã¨æœ¬ç•ªã§è¨­å®šãŒç•°ãªã‚‹å ´åˆã€`docker-compose`ã‚’ä½¿ã£ã¦ãã‚Œãã‚Œã®ç”¨é€”ã«é©ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•æ–¹æ³•ã‚’å®šç¾©ã™ã‚‹ã¨ã€ä¸€è²«ã—ãŸæ“ä½œæ€§ã‚’ä¿ã¡ã¤ã¤ã€ç’°å¢ƒã”ã¨ã®é•ã„ã‚’é©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ãã¾ã™ã€‚

---

é–‹ç™ºç”¨ã¨æœ¬ç•ªç”¨ã®`Dockerfile`ã‚’ä½œæˆä¾‹ã§ã™ã€‚

### é–‹ç™ºç”¨ã® Dockerfile

```Dockerfile
# é–‹ç™ºç”¨ã® Dockerfile

FROM ruby:3.2.2

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && \
    apt-get install -y build-essential libpq-dev nodejs

# Yarnã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - \
    && echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list \
    && apt-get update && apt-get install -y yarn

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
WORKDIR /myapp

# Gemãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY Gemfile* /myapp/
RUN bundle install

# ãã®ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚½ãƒ¼ã‚¹ã‚’ã‚³ãƒ”ãƒ¼
COPY . /myapp
```

### æœ¬ç•ªç”¨ã® Dockerfile

```Dockerfile
# æœ¬ç•ªç”¨ã® Dockerfile

FROM ruby:3.2.2 AS builder

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && \
    apt-get install -y build-essential libpq-dev nodejs

# Yarnã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - \
    && echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list \
    && apt-get update && apt-get install -y yarn

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
WORKDIR /myapp

# Gemãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY Gemfile* /myapp/
RUN bundle install --without development test \
    && rm -rf /usr/local/bundle/cache/*.gem \
    && find /usr/local/bundle/gems/ -name "*.c" -delete \
    && find /usr/local/bundle/gems/ -name "*.o" -delete

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚½ãƒ¼ã‚¹ã‚’ã‚³ãƒ”ãƒ¼
COPY . /myapp

# ã‚¢ã‚»ãƒƒãƒˆãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
RUN bundle exec rake assets:precompile

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
RUN useradd -m myuser
USER myuser

# å®Ÿè¡Œç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
FROM ruby:3.2.2

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && apt-get install -y libpq-dev && rm -rf /var/lib/apt/lists/*

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
WORKDIR /myapp

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
RUN useradd -m myuser
USER myuser

# ãƒ“ãƒ«ãƒ€ãƒ¼ã‹ã‚‰å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚³ãƒ”ãƒ¼
COPY --from=builder /usr/local/bundle/ /usr/local/bundle/
COPY --from=builder /myapp /myapp
```

**é–‹ç™ºç”¨ã®`Dockerfile`** ã¯ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ†ãƒŠå†…ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚åŸºæœ¬çš„ã«ã¯ãƒ‡ãƒãƒƒã‚°ã‚„ãƒ†ã‚¹ãƒˆã®ãƒ„ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ãŸã‚Šã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’å³æ™‚ã«åæ˜ ã•ã›ã‚‹å½¢ã«ãªã‚Šã¾ã™ã€‚

**æœ¬ç•ªç”¨ã®`Dockerfile`** ã¯ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆ`builder`ï¼‰ã¨ãƒ©ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’åˆ†ã‘ã€ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ã§ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚„ã‚¢ã‚»ãƒƒãƒˆã®ãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’è¡Œã„ã€ãƒ©ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ã§ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã¨ãƒ“ãƒ«ãƒ‰ã§ç”Ÿæˆã•ã‚ŒãŸã‚‚ã®ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è»½é‡ãªã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã¾ã™ã€‚ã¾ãŸã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã™ã‚‹ãŸã‚é root ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

å„ç’°å¢ƒã«ã‚ˆã£ã¦`docker-compose.yml`ã‚„`Dockerfile`ã‚’èª¿æ•´ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã®åŠ¹ç‡ã¨æœ¬ç•ªé‹ç”¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»åŠ¹ç‡ã‚’ä¸¡ç«‹ã•ã›ã¦ã„ãã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚

---

æœ¬ç•ªç’°å¢ƒã¨é–‹ç™ºç’°å¢ƒã§ç•°ãªã‚‹`Dockerfile`ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ãã‚Œã«ä¼´ã„`docker-compose.yml`ã‚‚ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹è¨­å®šã‚’æŒãŸã›ã‚‹ã®ãŒä¸€èˆ¬çš„ã§ã™ã€‚é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã§ã¯ã€ä½¿ã†ã‚³ãƒ³ãƒ†ãƒŠã®è¨­å®šã‚„ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®è¨­å®šãªã©ãŒç•°ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚

### é–‹ç™ºç”¨ `docker-compose.yml`

é–‹ç™ºç”¨ã®`docker-compose.yml`ã§ã¯ã€ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã‚’å³åº§ã«åæ˜ ã•ã›ã‚‹ãŸã‚ã«ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã€é–‹ç™ºãƒ„ãƒ¼ãƒ«ã‚’å«ã‚ãŸ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```yaml
version: "3"
services:
  db:
    image: postgres:16
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: myapp_development
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password

  web:
    build:
      context: .
      dockerfile: Dockerfile.dev # é–‹ç™ºç”¨ã®Dockerfileã‚’æŒ‡å®š
    ports:
      - "3000:3000"
    volumes:
      - ".:/myapp"
    depends_on:
      - db
```

### æœ¬ç•ªç”¨ `docker-compose.yml`

æœ¬ç•ªç’°å¢ƒç”¨ã®`docker-compose.yml`ã§ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–ã—ã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¯ä½¿ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚

```yaml
version: "3"
services:
  db:
    image: postgres:16
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: myapp_production
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: productionpassword

  web:
    build:
      context: .
      dockerfile: Dockerfile.prod # æœ¬ç•ªç”¨ã®Dockerfileã‚’æŒ‡å®š
    ports:
      - "3000:3000"
    depends_on:
      - db
```

ç•™æ„ç‚¹ã¨ã—ã¦ã€æœ¬ç•ªç’°å¢ƒã®`docker-compose.yml`ã§ã¯ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãªæƒ…å ±ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ï¼‰ã¯ç’°å¢ƒå¤‰æ•°ã‚„`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚‚ã—ãã¯ç§˜å¯†æƒ…å ±ã‚’å®‰å…¨ã«ç®¡ç†ã™ã‚‹ãŸã‚ã®å°‚ç”¨ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠå¤–ã‹ã‚‰æ¸¡ã™ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

ä¸¡ç’°å¢ƒã«ãŠã„ã¦ã€ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¹ãƒˆã‚¢ãªã©ï¼‰ã®è¨­å®šãŒç•°ãªã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ãŸã‚ã€ãã‚Œãã‚Œã®ç’°å¢ƒã«æœ€é©ãª`docker-compose.yml`ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªé–‹ç™ºãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãªãœ Docker ã§ãƒ“ãƒ«ãƒ‰æ™‚ã‚„ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ rails ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã›ãšã€ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã®ã‹ã€æŠ€è¡“è€…ã®è¦–ç‚¹ã§è¦‹è§£ã‚’å…¥ã‚ŒãŸã„ã§ã™ã€‚

---

`docker-compose`ã‚³ãƒãƒ³ãƒ‰ã¯`-f`ã¾ãŸã¯`--file`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã€ä½¿ç”¨ã™ã‚‹`docker-compose.yml`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚è¤‡æ•°ã®`docker-compose.yml`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒã£ã¦ã„ã‚‹å ´åˆï¼ˆä¾‹ãˆã°ã€`docker-compose.dev.yml`ã¨`docker-compose.prod.yml`ï¼‰ã€ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã©ã¡ã‚‰ã®è¨­å®šã§ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹ã‹ã‚’é¸ã¹ã¾ã™ã€‚

**é–‹ç™ºç’°å¢ƒã§ã®èµ·å‹•ä¾‹:**

```shell
docker-compose -f docker-compose.dev.yml up
```

**æœ¬ç•ªç’°å¢ƒã§ã®èµ·å‹•ä¾‹:**

```shell
docker-compose -f docker-compose.prod.yml up
```

`docker-compose up`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã€æŒ‡å®šã—ãŸ`docker-compose.yml`ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€è¤‡æ•°ã®`docker-compose.yml`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ã€è¨­å®šã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆä¸Šæ›¸ãï¼‰ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

**è¤‡æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ãŸèµ·å‹•ä¾‹:**

```shell
docker-compose -f docker-compose.yml -f docker-compose.override.yml up
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€æœ€åˆã«`docker-compose.yml`ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿ã€æ¬¡ã«`docker-compose.override.yml`ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§ã€æœ€åˆã®è¨­å®šã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€é–‹ç™ºç’°å¢ƒã‚„æœ¬ç•ªç’°å¢ƒã§ç•°ãªã‚‹è¨­å®šã‚’é©ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

---

# ãªãœãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã‹ã‚‰ Docker ã‚³ãƒ³ãƒ†ãƒŠã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã®ã‹ï¼ˆDocker ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ãªã„ã®ã¯ãªãœãªã®ã‹ï¼‰

Rails ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ä½œæˆã—ã¦ã‹ã‚‰ Docker ã‚³ãƒ³ãƒ†ãƒŠã«ã‚³ãƒ”ãƒ¼ã™ã‚‹æ–¹æ³•ã¨ã€Docker ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ç›´æ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã¯ã„ãšã‚Œã‚‚æœ‰åŠ¹ã§ã™ãŒã€ä»¥ä¸‹ã®è¦–ç‚¹ã‹ã‚‰å‰è€…ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒä¸€èˆ¬çš„ã«ã¨ã‚‰ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚

### 1. é–‹ç™ºåŠ¹ç‡

- **ã‚¨ãƒ‡ã‚£ã‚¿ã®åˆ©ä¾¿æ€§**: ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§ã€é–‹ç™ºè€…ã¯è‡ªèº«ã®ãŠæ°—ã«å…¥ã‚Šã®ã‚¨ãƒ‡ã‚£ã‚¿ã‚„ IDE ã‚’ç”¨ã„ã¦ã‚³ãƒ¼ãƒ‰ã‚’å®¹æ˜“ã«ç·¨é›†ã§ãã¾ã™ã€‚ç‰¹ã« IDE ã®å¼·åŠ›ãªã‚³ãƒ¼ãƒ‰è£œå®Œã‚„ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ç›´æ¥ã‚³ãƒ¼ãƒ‰ã‚’è§¦ã‚‹å ´åˆã«æœ‰åŠ¹ã§ã™ã€‚
- **ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãƒªã‚½ãƒ¼ã‚¹**: ãƒ­ãƒ¼ã‚«ãƒ«ã§ç”Ÿæˆãƒ»å®Ÿè¡Œã—ãŸæ–¹ãŒã€Docker ã‚³ãƒ³ãƒ†ãƒŠã‚’çµŒç”±ã™ã‚‹ã‚ˆã‚Šã‚‚ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãƒªã‚½ãƒ¼ã‚¹ï¼ˆCPU, ãƒ¡ãƒ¢ãƒª, I/Oï¼‰ã‚’åŠ¹ç‡çš„ã«åˆ©ç”¨ã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

### 2. ãƒ“ãƒ«ãƒ‰æ™‚é–“ã®çŸ­ç¸®

- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æœ€åˆã«ãƒ­ãƒ¼ã‚«ãƒ«ã§ç”Ÿæˆã—ã¦ãŠãã“ã¨ã§ã€`docker build`ã‚’å®Ÿè¡Œã™ã‚‹éš›ã«`bundle install`ãªã©ã®æ™‚é–“ã‚’çŸ­ç¸®ã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚Gemfile ãŒå¤‰ã‚ã‚‰ãªã„é™ã‚Š Docker ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã§ãã€ãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’ç¯€ç´„ã§ãã¾ã™ã€‚

### 3. çµ„ã¿è¾¼ã¿ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

- ãƒ­ãƒ¼ã‚«ãƒ«ã§ Rails ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€`rails new`ã‚³ãƒãƒ³ãƒ‰ã§ç”Ÿæˆã•ã‚Œã‚‹åˆæœŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨ã„ã¦ã€é–‹ç™ºè€…ã¯å³åº§ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ãã¾ã™ã€‚

### 4. ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚º

- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ä½œæˆã—ã€å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã“ã¨ã§ã€ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’å°ã•ãä¿ã¤ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ç‰¹ã« Node ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚„ä¸€éƒ¨ã® Gem ãªã©ã€å¤§é‡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¤šã„ãŸã‚ã€ã“ã‚Œã‚‰ã‚’ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«å«ã‚ã‚‹ã¨å¤§ãããªã‚ŠãŒã¡ã§ã™ã€‚

### 5. ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ãƒ‡ãƒãƒƒã‚°

- é–‹ç™ºä¸­ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§æ‰‹æ—©ãå‹•ä½œç¢ºèªã‚„ãƒ‡ãƒãƒƒã‚°ã‚’è¡Œã„ãŸã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ã¨ã€å…¨ã¦ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹ã“ã¨ãªãã€ç´ æ—©ãå‹•ä½œç¢ºèªãŒå¯èƒ½ã§ã™ã€‚

### 6. CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¨ã®æ•´åˆæ€§

- CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹å ´åˆã€ãƒ†ã‚¹ãƒˆã‚„ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†ã‚¹ãƒ†ãƒ¼ã‚¸ã§ã¯ã‚³ãƒ¼ãƒ‰ãŒã‚³ãƒ³ãƒ†ãƒŠã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã“ã¨ãŒä¸€èˆ¬çš„ã§ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®é–‹ç™ºãƒ•ãƒ­ãƒ¼ã¨ CI/CD ã®ãƒ•ãƒ­ãƒ¼ã‚’çµ±ä¸€ã™ã‚‹ã“ã¨ã§ã€æœ¬ç•ªç’°å¢ƒã«è¿‘ã„ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’å®¹æ˜“ã«æ§‹ç¯‰ã§ãã€ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### çµè«–

ã„ãšã‚Œã®æ–¹æ³•ã‚‚ä¸€é•·ä¸€çŸ­ãŒã‚ã‚Šã¾ã™ãŒã€ä¸Šè¨˜ã®ç†ç”±ã‹ã‚‰ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã«ã‚³ãƒ”ãƒ¼ã™ã‚‹æ–¹æ³•ãŒæ¡ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‹ãƒ¼ã‚ºã‚„é–‹ç™ºãƒãƒ¼ãƒ ã®ä½œæ¥­ã‚¹ã‚¿ã‚¤ãƒ«ã«ã‚ˆã£ã¦ã€æœ€é©ãªæ–¹æ³•ã¯ç•°ãªã‚‹ãŸã‚ã€ç‰¹å®šã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«æœ€ã‚‚é©ã—ãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’é¸æŠã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚
